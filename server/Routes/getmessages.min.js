const express=require("express"),db=require("../database/model"),{authenticate:authenticate}=require("./auth"),getmsgRouter=express.Router();getmsgRouter.post("/user",authenticate,(async(req,res)=>{const{id:id}=req.body;try{const foundPrivateMsgs=db.prepare("SELECT \n       MS.id AS 'key', \n       MS.user_id, \n       (SELECT U.username FROM users U WHERE U.id = MS.user_id) AS 'username',\n       MS.content, MS.timestamp,\n       COALESCE( \n       (SELECT \n         json_group_array( \n           json_object( 'key', MU.id, 'id', MD.id, 'name',MD.name, 'type', MD.type, 'url', MD.path, 'userid', MD.user_id, 'thumbnail', MD.thumbnail)\n         )\n       FROM mediaused MU\n       JOIN medias MD ON MU.media_id = MD.id\n       WHERE MU.assigned_id=MS.id AND MU.modules_id=2)\n       ,'[]'\n       ) AS attachments\n      FROM messages AS MS\n      JOIN one_one AS O ON MS.chat_id = O.id\n      WHERE O.id = ? AND MS.deletedYN='no'\n      ORDER BY MS.timestamp DESC LIMIT 50").all(id);void 0===foundPrivateMsgs&&(foundPrivateMsgs=[]),res.json({msgs:foundPrivateMsgs})}catch(err){return console.error("Private message error:",err),res.status(400).json({message:"Could not find message"})}})),module.exports={getmsgRouter:getmsgRouter};